{"data":{"site":{"siteMetadata":{"title":"Bruno Luiz Blog","author":"Bruno Luiz Silva"}},"markdownRemark":{"id":"79bb2f1a-2200-5476-b0b4-cea52b1ba9b3","excerpt":"Joi: validate input and define databases in JavaScript Photo by Rayi Christian Wicaksono on Unsplash As the saying goes:  never trust user input . People coming…","html":"<h1>Joi: validate input and define databases in JavaScript</h1>\n<p>Photo by Rayi Christian Wicaksono on Unsplash</p>\n<p>As the saying goes: <em>never trust user input</em>. People coming from PHP and Java have many validation libraries available. But what about JavaScript? There are some options, but none seems more interesting than Joi.</p>\n<p><a href=\"https://github.com/hapijs/joi\">Joi</a> is maintained by <a href=\"https://hapijs.com/\">Hapi.js project</a>. Even though hapi.js is a web framework by itself, Joi is independent and can be used in any type of node project. This is great for people using express or restify, for example.</p>\n<p>What makes it even more interesting is that, besides user validation, it can be used to define database schemas as well. This post will introduce a quick start guide, with some usage cases and general tweaks.</p>\n<h2>How to use it?</h2>\n<p>First things first: it has to be installed on the project. Considering an already initiated node project, the command to install it is: npm install joi. After being installed, a schema is required to use it, such as the file rating-schema.js below:</p>\n<iframe src=\"https://medium.com/media/6be80f7851d8f406c6e104d6346b54ce\" frameborder=0></iframe>\n<p>This defines a model where an username, a rating (from 1 to 5) and an email (which is a required field) are expected. This is a simple example, but there are way more validation options, which can be found on the <a href=\"https://github.com/hapijs/joi/blob/v10.6.0/API.md\">API reference</a>. To use the defined schema, consider a file called rating-test.js:</p>\n<iframe src=\"https://medium.com/media/7a1548a1fe0c2068080fc4606a067e39\" frameborder=0></iframe>\n<p><a href=\"https://github.com/hapijs/joi/blob/v10.6.0/API.md#errors\">More about Joi errors</a></p>\n<h2>Real project usage</h2>\n<h3>Validation middleware</h3>\n<p>In a real project, Joi can be used on a middleware layer. On <a href=\"http://expressjs.com\">express</a>, for example, this can be done using:</p>\n<iframe src=\"https://medium.com/media/c25e0ff780b02b819f99a08d6b92b2a3\" frameborder=0></iframe>\n<p>In this case, if the ratingsValidator returns an error due to validation, express will stop the request before even reaching the controller.</p>\n<h3>Database schema (MongoDB and DynamoDB)</h3>\n<p>Some tools can use it to define their database schema (keep in mind that Joi is not an ORM). For MongoDB, mongoose can be used together with <a href=\"https://github.com/yoitsro/joigoose\">joigoose</a>, which easily converts a Joi schema. For example:</p>\n<iframe src=\"https://medium.com/media/d8b457a81179375b7a9ca0ccee836d65\" frameborder=0></iframe>\n<p>Through <a href=\"https://github.com/ryanfitz/vogels\">vogels</a>, the same can be done in projects using DynamoDB. By default, it accepts Joi as its schema definition. The following example is based on vogels documentation:</p>\n<iframe src=\"https://medium.com/media/218d417fa17bf3b61675970748de03da\" frameborder=0></iframe>\n<h3>Exchangeability for front-end validation</h3>\n<p>Some developers prefer to define the schema once and then use everywhere, including on browsers. Today <a href=\"https://github.com/hapijs/joi/#browsers\">Joi doesn't support browser usage</a>, but a package called <a href=\"https://github.com/jeffbski/joi-browser\">joi-browser does this job</a>, enabling the usage of exactly the same schema on the front-end as well.</p>\n<h2>Useful tweaks</h2>\n<p><img src=\"https://cdn-images-1.medium.com/max/12032/1*6JEKFpOmUl79tToa0BtmwQ.jpeg\" alt=\"Photo by [chuttersnap](https://unsplash.com/photos/oEtQ0C6HS2I?utm_source=unsplash&#x26;utm_medium=referral&#x26;utm_content=creditCopyText) on [Unsplash](https://unsplash.com/?utm_source=unsplash&#x26;utm_medium=referral&#x26;utm_content=creditCopyText)\"><em>Photo by <a href=\"https://unsplash.com/photos/oEtQ0C6HS2I?utm_source=unsplash&#x26;utm_medium=referral&#x26;utm_content=creditCopyText\">chuttersnap</a> on <a href=\"https://unsplash.com/?utm_source=unsplash&#x26;utm_medium=referral&#x26;utm_content=creditCopyText\">Unsplash</a></em></p>\n<h3>#1: Disable Joi number() convert</h3>\n<p>By default, Joi allows users to pass numbers formatted as strings, in cases of number() fields. This is specially bad if the validate() result is only used to check if there was an error, but not for it's value field. To solve this, there are two possible solutions</p>\n<ol>\n<li>\n<p>On schema.validate(value), an extra parameter can be passed to disable it, as: schema.validate(value, { convert: false })</p>\n</li>\n<li>\n<p>Put a strict() at the end of the desired number field, as: Joi.number().strict()</p>\n</li>\n</ol>\n<p>Both of them are quite annoying, because either all fields or all function calls require a specific config. One way to solve this is by extending Joi…</p>\n<h3>#2: Extend Joi defaults</h3>\n<p>In cases such as the above, or for new field types, or even when the behavior of a default field has to be changed, Joi.extend() can be an option.</p>\n<iframe src=\"https://medium.com/media/aecdd34188b3655caed6729ccf82f221\" frameborder=0></iframe>\n<p>When using Joi through this file, all number fields will be on the strict mode — which solves the issue of applying tweak #1 everywhere — and a zipcode() validator is created, based on a pre-defined regex.</p>\n<p>More rules can be added and, actually, the Joi API enables <a href=\"https://github.com/hapijs/joi/blob/v10.6.0/API.md#extendextension\">much more customisation</a> on Joi.extend.</p>\n<h3>#3: Create default fields</h3>\n<p>In some projects, a lot of models will have some default fields, such as an extensionAttributes, where custom vendor data will be put into (as Magento already does) or updatedAt. In these cases, the Joi.object can be extended to include default fields:</p>\n<iframe src=\"https://medium.com/media/f836ec0088da872345e92119fd9000a5\" frameborder=0></iframe>\n<h3>#4: Show all validation errors</h3>\n<p>Usually Joi validation dies on the first error, returning on it's message which field failed. This is an issue when an input have many fields with problems. The user will have to do many requests to discover all problematic fields. To fix this issue, the following option can be added on the function call:</p>\n<p>const result = schema.validate(value, { abortEarly: false })</p>\n<p>With this config, if an error occurs, the result.error will return all validation failures.</p>\n<h3>#5: Built-in Joi conditional validations</h3>\n<p>If a field depends on values from another field, the conditional when() can be used.</p>\n<iframe src=\"https://medium.com/media/ec556ecc74daeedd3ccea3112b1ca547\" frameborder=0></iframe>\n<p>In this case, the field a accepts the value x, y, z. But, to accept y as a value, the field b have to be equals 5, otherwise only x and z will be accepted.</p>\n<p>Of course, this is a simple and fictitious conditional validation, but it is quite useful in cases where some field requires a specific validator when some other had a specific input.</p>\n<h2>Are you ready to use it?</h2>\n<p>I hope this post convinced you to use some validation tool such as Joi, instead of validating everything by hand (or not validating at all). But, if you are using it already: do you know any other cool trick or tweak? Let me know in the comments section below.</p>\n<h2>References</h2>\n<ul>\n<li>\n<p>Joi repo: <a href=\"https://github.com/hapijs/joi\">https://github.com/hapijs/joi</a></p>\n</li>\n<li>\n<p>Joi API Reference: <a href=\"https://github.com/hapijs/joi/blob/v10.6.0/API.md\">https://github.com/hapijs/joi/blob/v10.6.0/API.md</a></p>\n</li>\n<li>\n<p>Joigoose repo: <a href=\"https://github.com/yoitsro/joigoose\">https://github.com/yoitsro/joigoose</a></p>\n</li>\n<li>\n<p>Joi-browser repo: <a href=\"https://github.com/jeffbski/joi-browser\">https://github.com/jeffbski/joi-browser</a></p>\n</li>\n<li>\n<p>Mongoose website: <a href=\"http://mongoosejs.com\">http://mongoosejs.com</a></p>\n</li>\n<li>\n<p>Vogels repo: <a href=\"https://github.com/ryanfitz/vogels\">https://github.com/ryanfitz/vogels</a></p>\n</li>\n</ul>","frontmatter":{"title":"","date":null}}},"pageContext":{"slug":"/2017/aug/joi-validate-input-and-define-databases-in-javascript/","previous":{"fields":{"slug":"/2019/jan/hello-world/"},"frontmatter":{"title":"Hello World"}},"next":null}}